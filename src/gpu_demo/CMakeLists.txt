cmake_minimum_required(VERSION 3.0.2)
project(gpu_demo LANGUAGES CXX CUDA)

## Find catkin macros and libraries
find_package(catkin REQUIRED COMPONENTS
  roscpp
  std_msgs
  pcl_ros
  sensor_msgs
  rosbag
  rospy
  cv_bridge
  tf2_msgs
)

## System dependencies
find_package(PCL 1.8 REQUIRED COMPONENTS
  common
  io
  filters
  sample_consensus
)
find_package(CUDA REQUIRED)
find_package(OpenCV REQUIRED)
find_package(OpenMP REQUIRED)

# æŸ¥æ‰¾CUDAå·¥å…·åŒ…è·¯å¾„
find_path(CUDA_TOOLKIT_ROOT_DIR
    NAMES bin/nvcc
    PATHS /usr/local/cuda /usr/local/cuda-12.8
    NO_DEFAULT_PATH
)

# æ·»åŠ CUDAåº“è·¯å¾„
link_directories(${CUDA_TOOLKIT_ROOT_DIR}/targets/x86_64-linux/lib)

# è®¾ç½®CUDAç¼–è¯‘é€‰é¡¹
set(CUDA_NVCC_FLAGS "${CUDA_NVCC_FLAGS} -diag-suppress 20012")
set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} --extended-lambda")

# ğŸ†• æ·»åŠ ç®€åŒ–é”™è¯¯ä¿¡æ¯çš„ç¼–è¯‘é€‰é¡¹ï¼ˆåªä½¿ç”¨å¹¿æ³›æ”¯æŒçš„é€‰é¡¹ï¼‰
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -ftemplate-backtrace-limit=5")
# CUDA nvcc doesn't support backtrace limit, so only add to CXX flags

###################################
## catkin specific configuration ##
###################################
catkin_package(
 INCLUDE_DIRS include
 LIBRARIES quadric_detect_gpu_lib gpu_preprocessor_lib
 CATKIN_DEPENDS roscpp std_msgs pcl_ros sensor_msgs rosbag rospy cv_bridge tf2_msgs
 DEPENDS PCL OpenCV
)

###########
## Build ##
###########

## Specify additional locations of header files
include_directories(
  include
  ${catkin_INCLUDE_DIRS}
  ${PCL_INCLUDE_DIRS}
  ${CUDA_INCLUDE_DIRS}
  ${CUDA_TOOLKIT_ROOT_DIR}/include  # ğŸ†• ç¡®ä¿åŒ…å«CUDAå·¥å…·åŒ…å¤´æ–‡ä»¶ï¼ˆåŒ…å«CUBï¼‰
)

# æ·»åŠ PCLç¼–è¯‘å®šä¹‰
add_definitions(${PCL_DEFINITIONS})

## å£°æ˜Batch-RANSAC GPUæ£€æµ‹åº“
add_library(quadric_detect_gpu_lib
  src/QuadricDetect.cpp
  src/QuadricDetect.cu
)

## ğŸ†• æ–°å¢ï¼šGPUé¢„å¤„ç†åº“
add_library(gpu_preprocessor_lib
  src/GPUPreprocessor.cpp
  src/GPUPreprocessor_kernels.cu
)

# ğŸ†• ä¸º gpu_preprocessor_lib è®¾ç½®åˆ†ç¦»ç¼–è¯‘
set_property(TARGET gpu_preprocessor_lib 
             PROPERTY CUDA_SEPARABLE_COMPILATION ON)

# è®¾ç½®CUDAç¼–è¯‘é€‰é¡¹
target_compile_options(quadric_detect_gpu_lib PRIVATE 
  $<$<COMPILE_LANGUAGE:CUDA>:-diag-suppress 20012>
  $<$<COMPILE_LANGUAGE:CUDA>:--extended-lambda>
  $<$<COMPILE_LANGUAGE:CXX>:-ftemplate-backtrace-limit=5>
)

target_compile_options(gpu_preprocessor_lib PRIVATE 
  $<$<COMPILE_LANGUAGE:CUDA>:-diag-suppress 20012>
  $<$<COMPILE_LANGUAGE:CUDA>:--extended-lambda>
  $<$<COMPILE_LANGUAGE:CXX>:-ftemplate-backtrace-limit=5>
)

# é“¾æ¥ä¾èµ–åº“
target_link_libraries(quadric_detect_gpu_lib
  ${catkin_LIBRARIES}
  ${PCL_LIBRARIES}
  ${CUDA_LIBRARIES}
  cusolver  # cuSolver for batch SVD
  curand    # cuRAND for random number generation
)

# æ·»åŠ  OpenMP æ”¯æŒ
if(OpenMP_CXX_FOUND)
    target_link_libraries(gpu_preprocessor_lib
      ${catkin_LIBRARIES}
      ${PCL_LIBRARIES}
      ${CUDA_LIBRARIES}
      curand    # cuRAND for random number generation
      OpenMP::OpenMP_CXX
    )
    # è®¾ç½® OpenMP ç¼–è¯‘æ ‡å¿—
    target_compile_options(gpu_preprocessor_lib PRIVATE $<$<COMPILE_LANGUAGE:CXX>:${OpenMP_CXX_FLAGS}>)
else()
    target_link_libraries(gpu_preprocessor_lib
      ${catkin_LIBRARIES}
      ${PCL_LIBRARIES}
      ${CUDA_LIBRARIES}
      curand    # cuRAND for random number generation
    )
endif()

# GPUæ£€æŸ¥èŠ‚ç‚¹ (ğŸ†• æ›´æ–°ä¸ºå®Œæ•´çš„GPUæµæ°´çº¿æµ‹è¯•)
add_executable(gpu_check_node src/gpu_check.cpp)
target_link_libraries(gpu_check_node
  quadric_detect_gpu_lib
  gpu_preprocessor_lib
  ${catkin_LIBRARIES}
  ${PCL_LIBRARIES}
  ${CUDA_LIBRARIES}
  cusolver
  curand
)
add_dependencies(gpu_check_node ${${PROJECT_NAME}_EXPORTED_TARGETS} ${catkin_EXPORTED_TARGETS})


add_executable(SuperVoxel src/SuperVoxel.cpp)
target_link_libraries(SuperVoxel
  ${catkin_LIBRARIES}
  ${PCL_LIBRARIES}
)

# æµ‹è¯•demo_test ROSèŠ‚ç‚¹ - ä»£ç ä¿ç•™åœ¨demo_test.cpp.disabled
# add_executable(demo_test src/demo_test.cpp)
# target_link_libraries(demo_test
#   quadric_detect_gpu_lib
#   gpu_preprocessor_lib
#   ${catkin_LIBRARIES}
#   ${PCL_LIBRARIES}
#   ${CUDA_LIBRARIES}
#   cusolver
#   curand
# )
# add_dependencies(demo_test ${${PROJECT_NAME}_EXPORTED_TARGETS} ${catkin_EXPORTED_TARGETS})

# ğŸ†• æ–°å¢ï¼šGPUé¢„å¤„ç†æµ‹è¯•èŠ‚ç‚¹ - æµ‹è¯•GPUé¢„å¤„ç†åŠŸèƒ½
add_executable(test_preprocess_node src/test_preprocess.cpp)
target_link_libraries(test_preprocess_node
  gpu_preprocessor_lib
  ${catkin_LIBRARIES}
  ${PCL_LIBRARIES}
  ${CUDA_LIBRARIES}
)
add_dependencies(test_preprocess_node ${${PROJECT_NAME}_EXPORTED_TARGETS} ${catkin_EXPORTED_TARGETS})

# ğŸ†• æ–°å¢ï¼šæ³•çº¿è®¡ç®—æµ‹è¯•èŠ‚ç‚¹ - æµ‹è¯•ç©ºé—´å“ˆå¸Œæ³•çº¿è®¡ç®—
add_executable(normal_test src/normal_test.cpp)
target_link_libraries(normal_test
  gpu_preprocessor_lib
  ${catkin_LIBRARIES}
  ${PCL_LIBRARIES}
  ${CUDA_LIBRARIES}
)
add_dependencies(normal_test ${${PROJECT_NAME}_EXPORTED_TARGETS} ${catkin_EXPORTED_TARGETS})

#############
## Install ##
#############

# å®‰è£…åº“æ–‡ä»¶
install(TARGETS
  quadric_detect_gpu_lib
  gpu_preprocessor_lib
  gpu_check_node
  # demo_test  # å·²ç¦ç”¨
  test_preprocess_node
  normal_test
  ARCHIVE DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
  LIBRARY DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
  RUNTIME DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION}
)

# å®‰è£…å¤´æ–‡ä»¶
install(DIRECTORY include/${PROJECT_NAME}/
  DESTINATION ${CATKIN_PACKAGE_INCLUDE_DESTINATION}
  FILES_MATCHING PATTERN "*.h" PATTERN "*.cuh"
  PATTERN ".svn" EXCLUDE
)

# å®‰è£…Pythonè„šæœ¬
install(PROGRAMS
  script/generate_pointcloud.py
  script/transform.py
  DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION}
)

# å®‰è£…launchå’Œconfigæ–‡ä»¶
install(DIRECTORY launch/
  DESTINATION ${CATKIN_PACKAGE_SHARE_DESTINATION}/launch
  FILES_MATCHING PATTERN "*.launch"
)

install(DIRECTORY config/
  DESTINATION ${CATKIN_PACKAGE_SHARE_DESTINATION}/config
  FILES_MATCHING PATTERN "*.yaml"
)

#############
## Testing ##
#############

# æ·»åŠ åŸºäºgtestçš„æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
# catkin_add_gtest(${PROJECT_NAME}-test test/test_gpu_demo.cpp)
# if(TARGET ${PROJECT_NAME}-test)
#   target_link_libraries(${PROJECT_NAME}-test quadric_detect_gpu_lib)
# endif()
